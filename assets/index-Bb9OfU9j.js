import{d as N,c as r,r as C,K as W,x as j,y as O,m as Y,E as Z,A as ee}from"./index-DxsiHbDK.js";import{c as ae,C as T,k as le,D as te,n as ne,I as R,E as re,F as M,e as x,t as P,G as ie,h as U,m as B,z as oe,p as F,H as se,w as ce}from"./index-CWA1siCg.js";import{L as ue,g as de}from"./request-uc666yY3.js";import{s as fe}from"./function-call-BVFVrjNs.js";import{I as ve}from"./index-DAaGYlz9.js";import{c as me}from"./interceptor-CO5Y9v1H.js";const[ge,i,pe]=ae("uploader");function E(e,t){return new Promise(o=>{if(t==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},t==="dataUrl"?c.readAsDataURL(e):t==="text"&&c.readAsText(e)})}function G(e,t){return T(e).some(o=>o.file?le(t)?t(o.file):o.file.size>+t:!1)}function we(e,t){const o=[],c=[];return e.forEach(v=>{G(v,t)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const be=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,he=e=>be.test(e);function _(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?he(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ye=N({props:{name:ne,item:te(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:t,slots:o}){const c=()=>{const{status:n,message:f}=e.item;if(n==="uploading"||n==="failed"){const m=n==="failed"?r(R,{name:"close",class:i("mask-icon")},null):r(ue,{class:i("loading")},null),d=re(f)&&f!=="";return r("div",{class:i("mask")},[m,d&&r("div",{class:i("mask-message")},[f])])}},v=n=>{const{name:f,item:m,index:d,beforeDelete:k}=e;n.stopPropagation(),me(k,{args:[m,{name:f,index:d}],done:()=>t("delete")})},g=()=>t("preview"),y=()=>t("reupload"),p=()=>{if(e.deletable&&e.item.status!=="uploading"){const n=o["preview-delete"];return r("div",{role:"button",class:i("preview-delete",{shadow:!n}),tabindex:0,"aria-label":pe("delete"),onClick:v},[n?n():r(R,{name:"cross",class:i("preview-delete-icon")},null)])}},h=()=>{if(o["preview-cover"]){const{index:n,item:f}=e;return r("div",{class:i("preview-cover")},[o["preview-cover"](x({index:n},f))])}},I=()=>{const{item:n,lazyLoad:f,imageFit:m,previewSize:d,reupload:k}=e;return _(n)?r(ve,{fit:m,src:n.objectUrl||n.content||n.url,class:i("preview-image"),width:Array.isArray(d)?d[0]:d,height:Array.isArray(d)?d[1]:d,lazyLoad:f,onClick:k?y:g},{default:h}):r("div",{class:i("file"),style:M(e.previewSize)},[r(R,{class:i("file-icon"),name:"description"},null),r("div",{class:[i("file-name"),"van-ellipsis"]},[n.file?n.file.name:n.url]),h()])};return()=>r("div",{class:i("preview")},[I(),c(),p()])}});const ke={name:B(""),accept:U("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:B(1/0),imageFit:U("cover"),resultType:U("dataUrl"),uploadIcon:U("photograph"),uploadText:String,deletable:P,reupload:Boolean,afterRead:Function,showUpload:P,modelValue:ie(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:P,previewOptions:Object,previewFullImage:P,maxSize:{type:[Number,String,Function],default:1/0}};var Ie=N({name:ge,props:ke,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:t,slots:o}){const c=C(),v=[],g=C(-1),y=C(!1),p=(a=e.modelValue.length)=>({name:e.name,index:a}),h=()=>{c.value&&(c.value.value="")},I=a=>{if(h(),G(a,e.maxSize))if(Array.isArray(a)){const l=we(a,e.maxSize);if(a=l.valid,t("oversize",l.invalid,p()),!a.length)return}else{t("oversize",a,p());return}if(a=ee(a),g.value>-1){const l=[...e.modelValue];l.splice(g.value,1,a),t("update:modelValue",l),g.value=-1}else t("update:modelValue",[...e.modelValue,...T(a)]);e.afterRead&&e.afterRead(a,p())},n=a=>{const{maxCount:l,modelValue:u,resultType:s}=e;if(Array.isArray(a)){const w=+l-u.length;a.length>w&&(a=a.slice(0,w)),Promise.all(a.map(b=>E(b,s))).then(b=>{const Q=a.map((S,V)=>{const D={file:S,status:"",message:"",objectUrl:URL.createObjectURL(S)};return b[V]&&(D.content=b[V]),D});I(Q)})}else E(a,s).then(w=>{const b={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};w&&(b.content=w),I(b)})},f=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const u=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(u,p());if(!s){h();return}if(se(s)){s.then(w=>{n(w||u)}).catch(h);return}}n(u)};let m;const d=()=>t("closePreview"),k=a=>{if(e.previewFullImage){const l=e.modelValue.filter(_),u=l.map(s=>(s.objectUrl&&!s.url&&s.status!=="failed"&&(s.url=s.objectUrl,v.push(s.url)),s.url)).filter(Boolean);m=fe(x({images:u,startPosition:l.indexOf(a),onClose:d},e.previewOptions))}},q=()=>{m&&m.close()},H=(a,l)=>{const u=e.modelValue.slice(0);u.splice(l,1),t("update:modelValue",u),t("delete",a,p(l))},z=a=>{y.value=!0,g.value=a,Z(()=>L())},K=()=>{y.value||(g.value=-1),y.value=!1},X=(a,l)=>{const u=["imageFit","deletable","reupload","previewSize","beforeDelete"],s=x(F(e,u),F(a,u,!0));return r(ye,Y({item:a,index:l,onClick:()=>t(e.reupload?"clickReupload":"clickPreview",a,p(l)),onDelete:()=>H(a,l),onPreview:()=>k(a),onReupload:()=>z(l)},F(e,["name","lazyLoad"]),s),F(o,["preview-cover","preview-delete"]))},$=()=>{if(e.previewImage)return e.modelValue.map(X)},A=a=>t("clickUpload",a),J=()=>{const a=e.modelValue.length<+e.maxCount,l=e.readonly?null:r("input",{ref:c,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&g.value===-1,disabled:e.disabled,onChange:f,onClick:K},null);return o.default?j(r("div",{class:i("input-wrapper"),onClick:A},[o.default(),l]),[[O,a]]):j(r("div",{class:i("upload",{readonly:e.readonly}),style:M(e.previewSize),onClick:A},[r(R,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&r("span",{class:i("upload-text")},[e.uploadText]),l]),[[O,e.showUpload&&a]])},L=()=>{c.value&&!e.disabled&&c.value.click()};return W(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),de({chooseFile:L,reuploadFile:z,closeImagePreview:q}),oe(()=>e.modelValue),()=>r("div",{class:i()},[r("div",{class:i("wrapper",{disabled:e.disabled})},[$(),J()])])}});const ze=ce(Ie);export{ze as U};
